# PTTJS - plain text table javascript формат.

**Цель**: получить текстовый формат таблиц, который позволяет хранить более сложные таблицы, нежели существующие форматы, но при этом сохранять читаемость и текстовый формат.

**Необходимость**:

1. Чтобы научить LLM понимать более сложные таблицы нежели обычные CSV или MD таблицы. Очень часто в документах встречаются сложно составные таблицы, которые невозможно перевести в текстовый формат и приходится использовать мультимодальные модели, только из-за таких таблиц. К тому же когда CV или мультимодальная модель пытается переводить сложносоставную таблицу в текст, она также сталкивается с трудностями.
2. Чтобы научить LLM работать целиком с таблицей, всеми её данными и формулами. Сейчас методы взаимодействия LLM и каких-нибудь Excel таблиц больше похоже на большой набор костылей.
3. Чтобы работать с более сложными таблицами в текстовых редакторах по типу VSCode и Obsidian (через плагин).
4. Cчитаю Microsoft Excel и Google Sheets избыточными и не нужными для 90% задач. Хочу сделать легкий и простой инструмент, который работает с легким и простым форматом таблиц.

---

Первая строка всегда отдана под аннотацию:

`|PTTJS 1.0|encoding=UTF‑8|\n`

Каждая таблица лежит на странице:

`|(@P1|Название страницы){\n` - начало страницы, в скобках: id страницы начинается с символа "@" и название страницы.

`}|\n` - конец страницы.

Обозначения страницы опциональны, если их нет, вся таблица на одной странице.

---

Вся таблица состоит из ячеек и обозначения конца строки:

`|H([1|1]1|1|@C1)>` - начало ячейки, H - пометка, что это заголовок, в круглых скобках: индекс ячейки по X и Y в квадратных скобках, масштаб (scale) ячейки по X и Y и id ячейки (начинается с символа "@").

`<|\n` - конец строки.

H - опциональная пометка, что ячейка - это заголовок.

Индекс ячейки по X и Y - опционален, при обработке просто заполняется итеративно по ячейкам и строкам, начиная с [0|0]. Можно выгрузить при необходимости не визуальной обработки (в скрипте или c помощью AI).

Масштаб (scale) ячейки по X и Y - опционален и по умолчанию равен 1|1. **Масштаб всегда указывается в верхней левой ячейке**.

Id ячейки - опционален, нужен для ссылок и направленных формул.

Даже если в строке нет значений, но после неё есть строки, надо указать в строке хотя бы одну пустую ячейку "|><|".

---

Данные внутри ячеек не должны содержать символов ответственных за указание новой ячейки, конца строки, фигурных скобочек и переноса строки ("\n", "|", ">", "<", "{", "}").

Все эти символы должны быть заменены на URL Encode аналоги:

Новая строка (`\n`) -> `%5Cn`

Вертикальная черта (`|`) -> `%7C`

`>` -> `%3E`,

`<` -> `%3C`,

`{` -> `%7B`,

`}` -> `%7D`,

чтобы парсер валидно воспринимал данные.

В serializer.js есть функция `escapeValue`, которая может заменить символы на URL Encode вариант.

В parser.js есть функция `unescapeValue`, которая может заменить символы обратно из URL Encode варианта в обычный вид.

---

`>>>SCRIPT\n` - начало блока скриптов

`<<<SCRIPT\n` - конец блока скриптов

Блок скриптов всегда находится после всех данных и может работать с данными на разных листах.

Скрипты хранят формулы и форматирование, которые срабатывают при инициализации или изменении таблицы в совместимом редакторе.

Обработка ячеек делается с помощью JS кода и специально заготовленных JS функций.

Можно определять свои функции в редакторе.

Стили присваиваются с помощью символа "<=" и описываются в CSS подобном формате (тут также будут срабатывать JS функции для стилизации).

Форматы ячеек присваиваются символом "=>" и указывают на формат данных в ячейках (это тоже JS функции).

Например NUMBER(2,' '), первый параметр это decimals - количество цифр после запятой, а второй - разделитель тысяч, в нашем случае пробел ' '.

Можно добавлять скрипты для всей строки или столбца или вообще всего диапазона с помощью двойного указания индекса через двоеточие ":", например вся первая строка (0:0|0), или весь первый столбец (0|0:0) и т.д.

Скрипты это опциональный блок.

В ячейках всегда хранится актуальная информация. Когда мы добавляем скрипт, он пересчитывает данные таблицы и складывает по ячейкам актуальную информацию.

При выгрузке - скрипты можно сохранять отдельным файлом, например с суффиксом ".script".

---

**Пример** простой таблицы, например для хранения данных о машинах:

```
|PTTJS 1.0|encoding=UTF‑8|
|H>Номер машины|H>Год выпуска|H>Марка модель<|
|>080XXX02|>2007|>LEXUS RX 350<|
|>787XXX16|>2015|>GEELY GC7<|
|>871XXX05|>1997|>TOYOTA IPSUM<|
|>A602XXX|>1996|>MITSUBISHI PAJERO<|
|>890XXX02|>1997|>TOYOTA LAND CRUISER PRADO<|
|>216XXX13|>2007|>DAEWOO NEXIA<|

```

**Пример** простой таблицы для хранения данных о машинах, c индексами:

```
|PTTJS 1.0|encoding=UTF‑8|
|H([0|0])>Номер машины|H([1|0])>Год выпуска|H([2|0])>Марка модель<|
|([0|1])>080XXX02|([1|1])>2007|([2|1])>LEXUS RX 350<|
|([0|2])>787XXX16|([1|2])>2015|([2|2])>GEELY GC7<|
|([0|3])>871XXX05|([1|3])>1997|([2|3])>TOYOTA IPSUM<|
|([0|4])>A602XXX|([1|4])>1996|([2|4])>MITSUBISHI PAJERO<|
|([0|5])>890XXX02|([1|5])>1997|([2|5])>TOYOTA LAND CRUISER PRADO<|
|([0|6])>216XXX13|([1|6])>2007|([2|6])>DAEWOO NEXIA<|

```

**Пример** таблицы cо "сложным" заголовком для хранения данных о машинах:

```
|PTTJS 1.0|encoding=UTF‑8|
|H(1|2)>Номер машины|H(2|1)>Данные о машине|H><|
|H>|H>Год выпуска|H>Марка модель<|
|>080XXX02|>2007|>LEXUS RX 350<|
|>787XXX16|>2015|>GEELY GC7<|
|>871XXX05|>1997|>TOYOTA IPSUM<|
|>A602XXX|>1996|>MITSUBISHI PAJERO<|
|>890XXX02|>1997|>TOYOTA LAND CRUISER PRADO<|
|>216XXX13|>2007|>DAEWOO NEXIA<|

```

В этом примере объединены первые ячейки первых двух строк, с заголовком "номер машины" и объединены вторая и третья ячейки первой строки с заголовком "Данные о машине".

Как указано в аннотации, объединенные ячейки остаются, но они пустые. Это нужно чтобы не потерять позиционную информацию.

**Пример** простой таблицы для хранения данных о машинах, c индексами и скриптами:

```
|PTTJS 1.0|encoding=UTF‑8|
|H([0|0])>Номер машины|H([1|0])>Год выпуска|H([2|0])>Марка модель<|
|([0|1])>080XXX02|([1|1])>2007|([2|1])>LEXUS RX 350<|
|([0|2])>787XXX16|([1|2])>2015|([2|2])>GEELY GC7<|
|([0|3])>871XXX05|([1|3])>1997|([2|3])>TOYOTA IPSUM<|
|([0|4])>A602XXX|([1|4])>1996|([2|4])>MITSUBISHI PAJERO<|
|([0|5])>890XXX02|([1|5])>1997|([2|5])>TOYOTA LAND CRUISER PRADO<|
|([0|6])>216XXX13|([1|6])>2007|([2|6])>DAEWOO NEXIA<|
|([0|7])><|
|([0|8])>Средний год выпуска|([1|8])>2003<|

>>>SCRIPT
(1|1,1|6)=>NUMBER(2,' ')
(1|8)=DIV(SUM(1|1,1|6),COUNT(1|1,1|6))
(0|8:8)<=BORDER(each,2,solid,#000)
<<<SCRIPT
```

В этом примере у нас есть девятая строка, во второй ячейке которой лежит формула среднего значения диапазона ячеек.

Ещё указаны форматы ячеек во втором столбце со 2 по 7 строках, это числовой формат.

Также мы присвоили CSS стили диапазону ячеек, а именно обводку каждой ячейки черного цвета и толщиной 2.
